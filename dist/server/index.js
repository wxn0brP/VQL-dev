var g={html(t){return t!==void 0?(this.innerHTML=t,this):this.innerHTML},v(t){return t!==void 0?(this.value=t,this):this.value},on(t,e){this.addEventListener(t,e)},css(t,e=null){typeof t=="string"?e!==null?this.style[t]=e:this.style.cssText=t:Object.assign(this.style,t)},attrib(t,e=null){return e!==null?(this.setAttribute(t,e),this):this.getAttribute(t)||""},clA(...t){return this.classList.add(...t),this},clR(...t){return this.classList.remove(...t),this},clT(t,e){return this.classList.toggle(t,e),this},animateFade(t,e={}){let{time:r=200,cb:n}=e,s=this.style,i=50,o=r/i,a=(t===0?1:-1)/i,c=0;s.opacity=t.toString();let l=setInterval(()=>{if(c>=i){clearInterval(l),n?.();return}s.opacity=(parseFloat(s.opacity||"0")+a).toString(),c++},o);return this},fadeIn(t="block",e){return typeof t=="function"&&(e=t,t="block"),this.css("display",t),this.animateFade(0,{cb:e}),this.fade=!0,this},fadeOut(t){return this.animateFade(1,{time:300,cb:t}),setTimeout(()=>this.css("display","none"),300),this.fade=!1,this},async fadeInP(t="block"){return new Promise(e=>{this.fadeIn(t,e)}),this},async fadeOutP(){return new Promise(t=>{this.fadeOut(t)}),this},fade:!0,fadeToggle(){return this.fade?this.fadeOut():this.fadeIn(),this},add(t){return this.appendChild(t),this},addUp(t){return this.insertBefore(t,this.firstChild),this},qs(t){return this.querySelector(t)},qsi(t){return this.querySelector(t)},qi(t){return this.querySelector(`[data-id="${t}"]`)},qii(t){return this.querySelector(`[data-id="${t}"]`)}};Object.assign(HTMLElement.prototype,g);Object.assign(document,g);Object.assign(document.body,g);Object.assign(document.documentElement,g);for(let t of["qs","qsi","qi","qii"])typeof g[t]=="function"&&(window[t]=function(...e){return g[t].apply(document,e)});function C(t,e){return Object.keys(e).every(n=>t[n]!==void 0?typeof e[n]=="object"&&e[n]!==null?C(t[n],e[n]):t[n]===e[n]:!1)}function d(t,e){if(typeof e!="object"||e===null)throw new Error("Fields must be an object");if("$and"in e)return e.$and.every(n=>d(t,n));if("$or"in e)return e.$or.some(n=>d(t,n));if(!ve(t,e))return!1;let r=ge({...e});return C(t,r)}function ge(t){return["and","or","gt","lt","gte","lte","in","nin","exists","type","regex","arrinc","arrincall","size","startsWith","endsWith","between","not","subset"].map(r=>"$"+r).forEach(r=>delete t[r]),t}function ve(t,e){return Oe(t,e)&&xe(t,e)&&be(t,e)&&Ce(t,e)&&Ae(t,e)&&_e(t,e)&&ke(t,e)&&qe(t,e)&&$e(t,e)}function Oe(t,e){let r=["$gt","$lt","$gte","$lte","$in","$nin"];for(let n of r)if(n in e)for(let s of Object.entries(e[n])){let[i,o]=s;switch(n){case"$gt":if(!(t[i]>o))return!1;break;case"$lt":if(!(t[i]<o))return!1;break;case"$gte":if(!(t[i]>=o))return!1;break;case"$lte":if(!(t[i]<=o))return!1;break;case"$in":if(!o.includes(t[i]))return!1;break;case"$nin":if(o.includes(t[i]))return!1;break}}return!0}function xe(t,e){if("$exists"in e){for(let[r,n]of Object.entries(e.$exists))if(n&&!(r in t)||!n&&r in t)return!1}return!0}function be(t,e){if("$type"in e){for(let[r,n]of Object.entries(e.$type))if(typeof t[r]!==n)return!1}return!0}function Ce(t,e){if("$regex"in e){for(let[r,n]of Object.entries(e.$regex))if(!(typeof n=="string"?new RegExp(n):n).test(t[r]))return!1}return!0}function Ae(t,e){if("$arrinc"in e){for(let[r,n]of Object.entries(e.$arrinc))if(!Array.isArray(t[r])||!n.some(s=>t[r].includes(s)))return!1}if("$arrincall"in e){for(let[r,n]of Object.entries(e.$arrincall))if(!Array.isArray(t[r])||!n.every(s=>t[r].includes(s)))return!1}if("$size"in e)for(let[r,n]of Object.entries(e.$size))if(Array.isArray(t[r])||typeof t[r]=="string"){if(t[r].length!==n)return!1}else return!1;return!0}function _e(t,e){if("$startsWith"in e){for(let[r,n]of Object.entries(e.$startsWith))if(typeof t[r]!="string"||!t[r].startsWith(n))return!1}if("$endsWith"in e){for(let[r,n]of Object.entries(e.$endsWith))if(typeof t[r]!="string"||!t[r].endsWith(n))return!1}return!0}function ke(t,e){if("$between"in e){for(let[r,[n,s]]of Object.entries(e.$between))if(typeof t[r]!="number"||t[r]<n||t[r]>s)return!1}return!0}function qe(t,e){return"$not"in e?!d(t,e.$not):!0}function $e(t,e){if("$subset"in e){let r=e.$subset;return C(t,r)}return!0}function q(t,e){let{transform:r,select:n,exclude:s}=e;return typeof r=="function"&&(t=r(t)),Array.isArray(s)&&s.forEach(i=>{t.hasOwnProperty(i)&&delete t[i]}),Array.isArray(n)&&(t=n.reduce((i,o)=>(t.hasOwnProperty(o)&&(i[o]=t[o]),i),{})),t}function A(t){return t.replaceAll("//","/")}var U=class{_readFile;_writeFile;constructor(e,r){this._readFile=e,this._writeFile=r}async add(e,r){e=A(e);let n=await this._readFile(e);n.push(r),await this._writeFile(e,n)}async find(e,r,n={},s={}){e=A(e);let o=(await this._readFile(e)).filter(a=>typeof r=="function"?r(a,n):d(a,r));return o.length?o.map(a=>q(a,s)):[]}async findOne(e,r,n={},s={}){e=A(e);let o=(await this._readFile(e)).find(a=>typeof r=="function"?r(a,n):d(a,r));return o?q(o,s):!1}async remove(e,r,n,s={}){e=A(e);let i=await this._readFile(e),o=!1;return i=i.filter(a=>o&&r?!0:(typeof n=="function"?n(a,s):d(a,n))?(o=!0,!1):!0),o?(await this._writeFile(e,i),!0):!1}async update(e,r,n,s,i={}){e=A(e);let o=await this._readFile(e),a=!1;return o=o.map(c=>a&&r?c:(typeof n=="function"?n(c,i):d(c,n))?(a=!0,typeof s=="function"?s(c,i):{...c,...s}):c),a?(await this._writeFile(e,o),!0):!1}},D=U;var N=new Map,B,$=[],E=0,te=0,v=0;function S(t=null){t===null&&(t=[1,1]);let e=ne();return Ee({time:e,partsSchema:t,s:0})}function Ee(t){for(;;){let e=0;if(B){let o=B.split("-");if(o.shift()===t.time){let c=o.join("");e=parseInt(c,36)+1}}let r=t.partsSchema.reduce((o,a)=>o+a,0),n=Me(e,r),s=Ie(t.partsSchema,n),i=[t.time,...s].join("-");if(!N.has(i))return N.set(i,!0),setTimeout(()=>N.delete(i),1e3),B=i,i;t.s++,t.s>=r&&(t.time=ne(),t.s=0)}}function Se(){let t=Date.now();for($.push(t);E<$.length&&$[E]<t-1;)E++;return $.length-E}function Me(t,e){let r=Math.pow(36,e)-1,n=Se(),s=Date.now();if(n<3||s!==te)v=re(t,r),te=s;else{let i=Math.random();i<.6?v+=1:i<.9?v+=2:v=re(v,r)}return v.toString(36).padStart(e,"0")}function re(t,e){let r=t,n=Math.pow(Math.random(),3);return r=Math.floor(t+(e-t)*n),Math.min(r,e)}function Ie(t,e){let r=0;return t.map(n=>e.slice(r,r+=n))}function ne(){return new Date().getTime().toString(36)}function se(t,e){if(t==null&&e!=null)return 1;if(t!=null&&e==null)return-1;if(t==null&&e==null)return 0;let r=typeof t,n=typeof e;return r==="string"&&n==="string"?t.localeCompare(e):(r==="number"||t instanceof Date)&&(n==="number"||e instanceof Date)?t<e?-1:t>e?1:0:r==="boolean"&&n==="boolean"?t===e?0:t?1:-1:0}async function ie(t,e,r){let{search:n,context:s={},dbFindOpts:i={},findOpts:o={}}=t,{reverse:a=!1,max:c=-1,offset:l=0,sortBy:f,sortAsc:pe=!0}=i;a&&!f&&r.reverse();let y=[],b=0,k=0;for(let P of r){let u=await e.find(P,n,s,o);if(a&&!f&&u.reverse(),f)y.push(...u);else{if(l>k){let w=l-k;if(u.length<=w){k+=u.length;continue}u=u.slice(w),k=l}if(c!==-1)if(b+u.length>c){let w=c-b;u=u.slice(0,w),b=c}else b+=u.length;if(y.push(...u),c!==-1&&b>=c)break}}if(f){let P=pe?1:-1;y.sort((ye,we)=>se(ye[f],we[f])*P);let u=l,w=c!==-1?l+c:void 0;y=y.slice(u,w)}return y}function W(t){if(typeof t!="object"||Array.isArray(t))return;let e={};for(let r of Object.keys(t))r.startsWith("$")?Object.keys(t[r]).forEach(n=>{e[n]=t[r][n]}):e[r]=t[r];return e}function oe(t){t.data=Object.assign({},W(t.search),W(t.updater),W(t.add_arg))}var z=class{_inited=!0;async init(...e){}async getCollections(){throw new Error("Not implemented")}async ensureCollection(e){throw new Error("Not implemented")}async issetCollection(e){throw new Error("Not implemented")}async add(e){throw new Error("Not implemented")}async find(e){throw new Error("Not implemented")}async findOne(e){throw new Error("Not implemented")}async update(e){throw new Error("Not implemented")}async updateOne(e){throw new Error("Not implemented")}async remove(e){throw new Error("Not implemented")}async removeOne(e){throw new Error("Not implemented")}async removeCollection(e){throw new Error("Not implemented")}async updateOneOrAdd(e){let r=await this.updateOne(e);return r||(oe(e),await this.add(e)),r}},M=z;var I=class extends M{fileCpu;constructor(){super()}async add({collection:e,data:r,id_gen:n=!0}){return await this.ensureCollection(arguments[0]),n&&(r._id=r._id||S()),await this.fileCpu.add(e,r),r}async find(e){return await this.ensureCollection(e),await ie(e,this.fileCpu,[e.collection])}async findOne({collection:e,search:r,context:n={},findOpts:s={}}){return await this.ensureCollection(arguments[0]),await this.fileCpu.findOne(e,r,n,s)||null}async update({collection:e,search:r,updater:n,context:s={}}){return await this.ensureCollection(arguments[0]),await this.fileCpu.update(e,!1,r,n,s)}async updateOne({collection:e,search:r,updater:n,context:s={}}){return await this.ensureCollection(arguments[0]),await this.fileCpu.update(e,!0,r,n,s)}async remove({collection:e,search:r,context:n={}}){return await this.ensureCollection(arguments[0]),await this.fileCpu.remove(e,!1,r,n)}async removeOne({collection:e,search:r,context:n={}}){return await this.ensureCollection(arguments[0]),await this.fileCpu.remove(e,!0,r,n)}};var j=class{db;collection;constructor(e,r){this.db=e,this.collection=r}async add(e,r=!0){return await this.db.add(this.collection,e,r)}async find(e={},r={},n={},s={}){return await this.db.find(this.collection,e,r,n,s)}async findOne(e={},r={},n={}){return await this.db.findOne(this.collection,e,r,n)}async update(e,r,n={}){return await this.db.update(this.collection,e,r,n)}async updateOne(e,r,n={}){return await this.db.updateOne(this.collection,e,r,n)}async remove(e,r={}){return await this.db.remove(this.collection,e,r)}async removeOne(e,r={}){return await this.db.removeOne(this.collection,e,r)}async updateOneOrAdd(e,r,{add_arg:n={},context:s={},id_gen:i=!0}){return await this.db.updateOneOrAdd(this.collection,e,r,{add_arg:n,context:s,id_gen:i})}},O=j;function T(t){return new Proxy(t,{get(e,r,n){if(r in e)return Reflect.get(e,r,n);let s=new O(e,r);return e[r]=s,s},set(e,r,n,s){return Reflect.set(e,r,n,s)}})}var F=class{_events={};on(e,r){this._events[e]||(this._events[e]=[]),this._events[e].push(r)}once(e,r){let n=(...s)=>{this.off(e,n),r(...s)};this.on(e,n)}off(e,r){this._events[e]&&(this._events[e]=this._events[e].filter(n=>n!==r))}emit(e,...r){let n=this._events[e];n&&n.length>0&&n.forEach(s=>{s(...r)})}listenerCount(e){return this._events[e]?.length||0}};var H=class{quote;isExecuting;constructor(){this.quote=[],this.isExecuting=!1}async addOp(e,...r){return await new Promise((n,s)=>{this.quote.push({func:e,param:r,resolve:n,reject:s}),this.execute()})}async execute(){if(!this.isExecuting){for(this.isExecuting=!0;this.quote.length>0;){let e=this.quote.shift(),r=await e.func(...e.param);e.resolve(r)}this.isExecuting=!1}}},ae=H;var ce="0.2.3";var K=class{dbAction;executor;emiter;version=ce;constructor(e={}){this.dbAction=e.dbAction||new M,this.executor=e.executor||new ae,this.emiter=new F}async init(...e){if(this.dbAction._inited)return;let r=this;return await this.executor.addOp(async()=>{r.dbAction._inited||(await r.dbAction.init(...e),r.dbAction._inited=!0)})}async execute(e,r){await this.init();let n=await this.executor.addOp(this.dbAction[e].bind(this.dbAction),r),s=Array.from(arguments).slice(1);return this.emiter.emit(e,s,n),this.emiter.emit("*",e,s,n),n}c(e){return new O(this,e)}async getCollections(){return await this.execute("getCollections",{})}async ensureCollection(e){return await this.execute("ensureCollection",{collection:e})}async issetCollection(e){return await this.execute("issetCollection",{collection:e})}async add(e,r,n=!0){return await this.execute("add",{collection:e,data:r,id_gen:n})}async find(e,r={},n={},s={},i={}){return await this.execute("find",{collection:e,search:r,context:i,dbFindOpts:n,findOpts:s})}async findOne(e,r={},n={},s={}){return await this.execute("findOne",{collection:e,search:r,context:s,findOpts:n})}async update(e,r,n,s={}){return await this.execute("update",{collection:e,search:r,updater:n,context:s})}async updateOne(e,r,n,s={}){return await this.execute("updateOne",{collection:e,search:r,updater:n,context:s})}async remove(e,r,n={}){return await this.execute("remove",{collection:e,search:r,context:n})}async removeOne(e,r,n={}){return await this.execute("removeOne",{collection:e,search:r,context:n})}async updateOneOrAdd(e,r,n,{add_arg:s={},context:i={},id_gen:o=!0}={}){return await this.execute("updateOneOrAdd",{collection:e,search:r,updater:n,add_arg:s,context:i,id_gen:o})}async removeCollection(e){return await this.execute("removeCollection",{collection:e})}},Q=K;var J=class extends I{memory;constructor(){super(),this.fileCpu=new D(this._readMemory.bind(this),this._writeMemory.bind(this)),this.memory=new Map}_readMemory(e){return this.memory.has(e)?this.memory.get(e):[]}_writeMemory(e,r){this.memory.set(e,r)}async getCollections(){return Array.from(this.memory.keys())}async ensureCollection({collection:e}){if(!this.issetCollection(e))return this.memory.set(e,[]),!0}async issetCollection({collection:e}){return this.memory.has(e)}async removeCollection({collection:e}){return this.memory.delete(e),!0}},_=class extends Q{constructor(...e){super({dbAction:new J})}};function G(t){let e=new _;if(!t)return T(e);for(let r of Object.keys(t))e.dbAction.memory.set(r,t[r]);return T(e)}import Te from"@wxn0brp/vql";var X=G(),p=new Te({db:X});var Y=new BroadcastChannel("VQL");function Fe(t,e){let r=e.version;return t==="local"?r+="-local.0":r+="-client.0",{logic_id:t,type:"valthera",version:r}}function Le(){let t=[];for(let[e,r]of Object.entries(p.dbInstances))t.push(Fe(e,r));return t}Y.onmessage=async t=>{let e=t.data.data,r=t.data.type;if(console.log(r,e),r==="getAdapters")Y.postMessage({type:"getAdapters",data:Le()});else if(r==="vql"){let n=e.id;typeof e.query=="string"&&console.log("->",p._parseQuery(e.query));let s=await p.execute(e.query,{});Y.postMessage({type:"vql-"+n,data:s})}};function Re(t){let e=[];function r(s){return typeof s=="function"?s.toString():s}function n(s,i=""){Object.keys(s).forEach(o=>{let a=s[o],c=i?`${i}.${o.replace(/\./g,"[dot]")}`:o;typeof a=="function"?(e.push(c),s[o]=r(a)):Array.isArray(a)?a.forEach((l,f)=>{typeof l=="function"&&(e.push(`${c}[${f}]`),a[f]=r(l))}):typeof a=="object"&&a!==null&&n(a,c)})}return n(t),{data:t,keys:e}}var ue=Re;var le="0.2.0";var L=class{remote;version=le;constructor(e){if(typeof e=="string"){let r=new URL(e),n=r.username,s=r.password;if(!n||!s)throw new Error("Invalid remote database");r.username="",r.password="";let i=r.toString().slice(0,-1);this.remote={name:n,url:i,auth:s}}else this.remote=e;this.remote.url.endsWith("/")&&(this.remote.url=this.remote.url.slice(0,-1))}async _request(e,r=[]){let n=ue(r),s={db:this.remote.name,params:n.data,keys:n.keys},i=this.remote.url+"/db/"+e,o=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:this.remote.auth},body:JSON.stringify(s)}).then(a=>a.json());if(o.err)throw new Error(o.msg);return o.result}c(e){return new O(this,e)}async getCollections(){return await this._request("getCollections",[])}async ensureCollection(e){return await this._request("ensureCollection",[e])}async issetCollection(e){return await this._request("issetCollection",[e])}async add(e,r,n=!0){return await this._request("add",[e,r,n])}async find(e,r,n={},s={},i={}){return await this._request("find",[e,r,n,s,i])}async findOne(e,r,n={},s={}){return await this._request("findOne",[e,r,n,s])}async update(e,r,n,s={}){return await this._request("update",[e,r,n,s])}async updateOne(e,r,n,s={}){return await this._request("updateOne",[e,r,n,s])}async remove(e,r,n={}){return await this._request("remove",[e,r,n])}async removeOne(e,r,n={}){return await this._request("removeOne",[e,r,n])}async updateOneOrAdd(e,r,n,s){return await this._request("updateOneOrAdd",[e,r,n,s])}async removeCollection(e){return await this._request("removeCollection",[e])}};var m=document.querySelector("textarea"),Z=document.querySelector("ul");document.querySelector("#run").addEventListener("click",()=>R());m.addEventListener("keyup",t=>{t.shiftKey&&t.key==="Enter"&&R()});document.querySelector("#save").addEventListener("click",()=>{let t=m.value;localStorage.setItem("vql-server-config",t)});setTimeout(()=>{let t=localStorage.getItem("vql-server-config");t&&(m.value=t,R())},100);var V=qsi("#alias"),x=qs("#alias-select"),fe=qsi("#name"),de=qsi("#auth"),he=qsi("#url");function ee(){let t=Object.keys(h);x.innerHTML="";let e=document.createElement("option");e.value="",e.text="Add",x.add(e);for(let r of t){let n=document.createElement("option");n.value=r,n.text=r,x.add(n)}}function me(t){if(!h[t])return;let e=new URL(h[t]);x.value=t,V.value=t,fe.value=e.username,de.value=e.password,he.value=e.origin}V.addEventListener("change",()=>me(V.value));x.addEventListener("change",()=>me(x.value));qs("form").addEventListener("submit",t=>{t.preventDefault();let e=V.value,r=new URL(he.value);r.username=fe.value,r.password=de.value,m.value=m.value.split(`
`).map(n=>n.trim()&&n.split(" ")[0]===e?`${e} ${r.href}`:n).join(`
`),ee()});var h={};function Ve(t){let e={};for(let[r,n]of Object.entries(t))e[r]=new L(n);e.local=X,p.dbInstances=e,p.relation.dbs=e}function Pe(){h={};let t=m.value.split(`
`);for(let e of t){if(!e)continue;let[r,n]=e.split(" ");h[r]=n}}async function R(){Pe(),Ve(h),Z.innerHTML="<li>local: OK</li>",Object.keys(h).forEach(async e=>{let r=h[e],n=new URL(r),s=n.username,i=n.password;n.password="",n.username="";let o=!1;try{await fetch(n+"/db/getCollections",{method:"POST",headers:{"Content-Type":"application/json",Authorization:i},body:JSON.stringify({db:s})}),o=!0}catch{o=!1}let a=document.createElement("li");a.textContent=`${e}: ${o?"OK":"ERR"}`,Z.appendChild(a)}),ee()}
//# sourceMappingURL=index.js.map
